<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>DRE Face Sheet & Narrative</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  @page { size: Letter; margin: 12mm; }
  * { box-sizing: border-box; }
  body { font-family: Arial, Helvetica, sans-serif; margin:0; color:#111; }
  .sheet { page-break-after: always; padding:0; }
  .title { text-align:center; font-weight:700; font-size:16px; margin:0 0 6px; }
  .subtitle { text-align:center; color:#4b5563; font-size:11px; margin:0 0 10px; }
  .section { font-weight:700; color:#0c2e63; margin:12px 0 6px; text-transform:uppercase; font-size:12px; }
  .grid { display:grid; grid-template-columns: repeat(3,1fr); gap:6px 12px; }
  .grid.two { grid-template-columns: repeat(2,1fr); }
  .grid.one { grid-template-columns: 1fr; }
  .kv { display:grid; grid-template-columns: 150px 1fr; gap:4px 8px; font-size:12px; align-items:center; }
  .kv .k { font-weight:700; color:#0c2e63; }
  .kv .v { border-bottom:1px solid #cfd8ea; min-height:16px; padding:2px 0; }
  table.matrix { width:100%; border-collapse:collapse; font-size:12px; margin-top:4px; }
  table.matrix th, table.matrix td { border:1px solid #cfd8ea; padding:5px 6px; vertical-align:top; }
  table.matrix th { background:#edf2fc; color:#0c2e63; }
  .notes { font-size:11px; color:#4b5563; }
  .narr { white-space:pre-wrap; line-height:1.4; font-size:12px; }
  .checkbox-cell { display:flex; align-items:center; gap:6px; }
  .box { border:1px solid #cfd8ea; border-radius:6px; padding:8px; margin-top:4px; }
  .pill { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border:1px solid #cfd8ea; border-radius:999px; margin:2px; font-size:11px; }
  .foot { text-align:right; font-size:10px; color:#6b7280; margin-top:6px; }
</style>
</head>
<body>

<% function fmt(val){ return val || ""; } %>
<% function fmtList(list){ if(Array.isArray(list)) return list.join(', '); if(typeof list === 'string') return list; return ''; } %>

<div class="sheet">
  <div class="title">DRUG INFLUENCE EVALUATION — FACE SHEET</div>
  <div class="subtitle">Page 1 · Case · Subject · Interview · Medical · Preliminary Exam</div>

  <div class="section">Case / Evaluator</div>
  <div class="grid">
    <div class="kv"><div class="k">Evaluator</div><div class="v"><%= fmt(data.Evaluator) %></div></div>
    <div class="kv"><div class="k">DRE #</div><div class="v"><%= fmt(data.DRE_Number) %></div></div>
    <div class="kv"><div class="k">Rolling Log #</div><div class="v"><%= fmt(data.Rolling_Log_Number) %></div></div>
    <div class="kv"><div class="k">Case #</div><div class="v"><%= fmt(data.Case_Number) %></div></div>
    <div class="kv"><div class="k">Incident #</div><div class="v"><%= fmt(data.Incident_Number) %></div></div>
    <div class="kv"><div class="k">Recorder / Witnesses</div><div class="v"><%= fmt(data.Witnesses) %></div></div>
    <div class="kv"><div class="k">Arresting Officer</div><div class="v"><%= fmt(data.Arresting_Officer) %></div></div>
    <div class="kv"><div class="k">Officer's Agency</div><div class="v"><%= fmt(data.Arresting_Agency) %></div></div>
    <div class="kv"><div class="k">Date Examined</div><div class="v"><%= fmt(data.Eval_Date) %></div></div>
    <div class="kv"><div class="k">Time Examined</div><div class="v"><%= fmt(data.Eval_Time) %></div></div>
    <div class="kv"><div class="k">Location</div><div class="v"><%= [data.Eval_Location, [data.Location_County, data.Location_State].filter(Boolean).join(', ')].filter(Boolean).join(', ') %></div></div>
  </div>
  <div class="grid two" style="margin-top:6px">
    <div class="kv"><div class="k">Miranda Warning</div><div class="v"><%= data.Miranda === 'Yes' ? `Yes — ${fmt(data.Miranda_Given_By)}` : fmt(data.Miranda) %></div></div>
    <div class="kv"><div class="k">Crash</div><div class="v"><%= fmt(data.Crash) %></div></div>
    <div class="kv"><div class="k">Chemical Test</div><div class="v"><%= fmt(data.Chemical_Test) %></div></div>
  </div>

  <div class="section">Subject</div>
  <div class="grid">
    <div class="kv"><div class="k">Name</div><div class="v"><%= fmt(data.Subject_Name) %></div></div>
    <div class="kv"><div class="k">DOB</div><div class="v"><%= fmt(data.Subject_DOB) %></div></div>
    <div class="kv"><div class="k">Age</div><div class="v"><%= fmt(data.Subject_Age) %></div></div>
    <div class="kv"><div class="k">Sex</div><div class="v"><%= fmt(data.Subject_Gender) %></div></div>
    <div class="kv"><div class="k">Race</div><div class="v"><%= fmt(data.Subject_Race) %></div></div>
    <div class="kv"><div class="k">Breath Test</div><div class="v"><%= data.Breath_Refused ? 'Refused' : fmt(data.Breath_Result) %></div></div>
    <div class="kv"><div class="k">Instrument #</div><div class="v"><%= fmt(data.Breath_Instrument) %></div></div>
  </div>

  <div class="section">Interview</div>
  <div class="grid two">
    <div class="kv"><div class="k">Food</div><div class="v"><%= [data.What_Eaten, data.When_Eaten].filter(Boolean).join(' — ') %></div></div>
    <div class="kv"><div class="k">Alcohol</div><div class="v"><%= [data.What_Drinking, data.When_Drinking, data.Last_Drink].filter(Boolean).join(' / ') %></div></div>
    <div class="kv"><div class="k">Time now (stated)</div><div class="v"><%= fmt(data.Time_Now) %></div></div>
    <div class="kv"><div class="k">Actual time</div><div class="v"><%= fmt(data.Time_Actual) %></div></div>
    <div class="kv"><div class="k">Last sleep</div><div class="v"><%= [data.Last_Slept, data.Sleep_Amount].filter(Boolean).join(' — ') %></div></div>
  </div>

  <div class="section">Medical / Physical</div>
  <table class="matrix">
    <tr><th>Prompt</th><th>Answer</th><th>Notes</th></tr>
    <tr><td>Sick or injured</td><td><%= fmt(data.Sick_Injured) %></td><td><%= fmt(data.Sick_Notes) %></td></tr>
    <tr><td>Diabetic or epileptic</td><td><%= fmt(data.Diabetic_Epileptic) %></td><td><%= fmt(data.Diabetic_Eplieptic_Notes) %></td></tr>
    <tr><td>Takes insulin</td><td><%= fmt(data.Insulin) %></td><td></td></tr>
    <tr><td>Physical defects</td><td><%= fmt(data.Defects) %></td><td><%= fmt(data.Defect_Notes) %></td></tr>
    <tr><td>Under doctor/dentist care</td><td><%= fmt(data.Doctor) %></td><td><%= fmt(data.Doctor_Notes) %></td></tr>
    <tr><td>Medications / drugs</td><td><%= fmt(data.Meds_Drugs) %></td><td><%= fmt(data.Meds_Drugs_Notes) %></td></tr>
  </table>

  <div class="section">Preliminary Exam</div>
  <table class="matrix">
    <tr>
      <th>Attitude</th><td><%= fmt(data.Attitude) %></td>
      <th>Coordination</th><td><%= fmt(data.Coordination) %></td>
      <th>Speech</th><td><%= fmt(data.Speech) %></td>
    </tr>
    <tr>
      <th>Breath Odor</th><td><%= fmt(data.Breath_Odor) %></td>
      <th>Face</th><td><%= fmt(data.Face) %></td>
      <th>First Pulse</th><td><%= fmt(data.Pulse1_Display || data.Pulse1) %></td>
    </tr>
    <tr>
      <th>Corrective Lenses</th><td colspan="5"><%= fmt(data.Corrective_Lenses) %></td>
    </tr>
    <tr>
      <th>Eyes</th><td><%= fmtList(data.Eyes) %></td>
      <th>Blindness</th><td><%= fmtList(data.Blind) %></td>
      <th>Tracking</th><td><%= fmt(data.Tracking) %></td>
    </tr>
    <tr>
      <th>Pupil size</th><td><%= fmt(data.Pupil_Size) %></td>
      <th>Pupil notes</th><td colspan="3"><%= fmt(data.Pupil_Size_Notes) %></td>
    </tr>
    <tr>
      <th>Resting Nystagmus</th><td><%= fmt(data.Resting_Nystagmus) %></td>
      <th>Vertical Nystagmus</th><td><%= fmt(data.Vertical_Nystagmus) %></td>
      <th>Able to follow stimulus</th><td><%= fmt(data.Able_To_Follow) %></td>
    </tr>
    <tr>
      <th>Eyelids</th><td><%= fmt(data.Eyelids) %></td>
      <th colspan="4">Preliminary Notes</th>
    </tr>
    <tr>
      <td colspan="6"><%= fmt(data.Prelim_Notes) %></td>
    </tr>
  </table>
  <div class="foot">Face Sheet Page 1</div>
</div>

<div class="sheet">
  <div class="title">DRUG INFLUENCE EVALUATION — FACE SHEET</div>
  <div class="subtitle">Page 2 · HGN · Psychophysical Tests</div>

  <div class="section">HGN / VGN / Convergence</div>
  <table class="matrix">
    <tr><th></th><th>Lack of Smooth Pursuit</th><th>Distinct &amp; Sustained at Max Deviation</th><th>Angle of Onset</th></tr>
    <tr><th>Left Eye</th><td><%= fmt(data.HGN_Pursuit_L) %></td><td><%= fmt(data.HGN_Max_L) %></td><td><%= fmt(data.HGN_Angle_L) %></td></tr>
    <tr><th>Right Eye</th><td><%= fmt(data.HGN_Pursuit_R) %></td><td><%= fmt(data.HGN_Max_R) %></td><td><%= fmt(data.HGN_Angle_R) %></td></tr>
    <tr><th>Vertical Gaze Nystagmus</th><td colspan="1"><%= fmt(data.Vertical_Nyst) %></td><th>Lack of Convergence</th><td><%= fmt(data.LOC) %></td></tr>
  </table>

  <div class="section">Modified Romberg Balance</div>
  <table class="matrix">
    <tr><th>Front/Back Sway</th><td><%= fmt(data.MRB_1) %></td><th>Side Sway</th><td><%= fmt(data.MRB_2) %></td><th>Time Estimation</th><td><%= fmt(data.MRB_Time) %></td></tr>
    <tr><th colspan="6">Notes</th></tr>
    <tr><td colspan="6"><%= fmt(data.MRB_Notes) %></td></tr>
  </table>

  <div class="section">Walk and Turn</div>
  <table class="matrix">
    <tr>
      <th>Refused</th><td><%= data.WAT_Refused ? 'Yes' : '' %></td>
      <th>Not Given</th><td><%= data.WAT_NotGiven ? 'Yes' : '' %></td>
      <th>Footwear</th><td><%= fmt(data.WAT_Footwear) %></td>
    </tr>
    <tr>
      <th>Instruction Phase</th>
      <td colspan="5">
        Balance: <%= fmt(data.WAT_Balance) %> · Starts too soon: <%= fmt(data.WAT_Too_Soon) %> · Stops: <%= fmt(data.WAT_Stops_1) %>
        · Misses heel-to-toe: <%= fmt(data.WAT_Miss_1) %> · Steps off line: <%= fmt(data.WAT_Off_1) %> · Raises arms: <%= fmt(data.WAT_Arms_1) %>
        · Wrong steps: <%= fmt(data.WAT_Steps_1) %>
      </td>
    </tr>
    <tr>
      <th>Walking Phase</th>
      <td colspan="5">
        Stops: <%= fmt(data.WAT_Stops_2) %> · Misses heel-to-toe: <%= fmt(data.WAT_Miss_2) %> · Steps off line: <%= fmt(data.WAT_Off_2) %>
        · Raises arms: <%= fmt(data.WAT_Arms_2) %> · Wrong steps: <%= fmt(data.WAT_Steps_2) %>
      </td>
    </tr>
    <tr><th>Turn</th><td colspan="5"><%= fmt(data.WAT_Turn) %></td></tr>
    <tr><th>Unable to perform</th><td colspan="5"><%= fmt(data.WAT_Cant_Do) %></td></tr>
    <tr><th>Notes</th><td colspan="5"><%= fmt(data.WAT_Notes) %></td></tr>
  </table>

  <div class="section">One Leg Stand</div>
  <table class="matrix">
    <tr><th>Leg</th><th>Count</th><th>Sways</th><th>Raises Arms</th><th>Hops</th><th>Foot Down</th><th>Refused</th><th>Not Given</th></tr>
    <% ["L","R"].forEach(side => { %>
    <tr>
      <th><%= side === 'L' ? 'Left' : 'Right' %></th>
      <td><%= fmt(data[`OLS_${side}_Count`]) %></td>
      <td><%= data[`OLS_${side}_Sway`] ? 'Yes' : '' %></td>
      <td><%= data[`OLS_${side}_Arms`] ? 'Yes' : '' %></td>
      <td><%= data[`OLS_${side}_Hop`] ? 'Yes' : '' %></td>
      <td><%= data[`OLS_${side}_Down`] ? 'Yes' : '' %></td>
      <td><%= data[`OLS_${side}_Refused`] ? 'Yes' : '' %></td>
      <td><%= data[`OLS_${side}_Not_Given`] ? 'Yes' : '' %></td>
    </tr>
    <% }) %>
  </table>

  <div class="section">Finger to Nose</div>
  <table class="matrix">
    <tr><th>Attempt</th><th>Sways</th><th>Uses Pad</th><th>Searches</th><th>Eyes Open</th><th>Wrong Hand</th><th>Missed Nose</th></tr>
    <% [1,2,3,4,5,6].forEach(num => { %>
    <tr>
      <th><%= num %></th>
      <td><%= data[`FTN_Sway_${num}`] ? 'Yes' : '' %></td>
      <td><%= data[`FTN_Pad_${num}`] ? 'Yes' : '' %></td>
      <td><%= data[`FTN_Searched_${num}`] ? 'Yes' : '' %></td>
      <td><%= data[`FTN_Eyes_${num}`] ? 'Yes' : '' %></td>
      <td><%= data[`FTN_Wrong_${num}`] ? 'Yes' : '' %></td>
      <td><%= data[`FTN_Down_${num}`] ? 'Yes' : '' %></td>
    </tr>
    <% }) %>
  </table>
  <div class="foot">Face Sheet Page 2</div>
</div>

<div class="sheet">
  <div class="title">DRUG INFLUENCE EVALUATION — FACE SHEET</div>
  <div class="subtitle">Page 3 · Vitals · Oral/Nasal · Timeline · Opinion · Narrative</div>

  <div class="section">Vital Signs & Pupils</div>
  <table class="matrix">
    <tr><th>Second Pulse</th><td><%= fmt(data.Pulse2_Display || data.Pulse2) %></td><th>Third Pulse</th><td><%= fmt(data.Pulse3_Display || data.Pulse3) %></td><th>Blood Pressure</th><td><%= fmt(data.BP) %></td></tr>
    <tr><th>Temperature</th><td><%= fmt(data.Body_Temp) %></td><th colspan="4">Vitals Notes</th></tr>
    <tr><td colspan="6"><%= fmt(data.Vital_Notes) %></td></tr>
  </table>
  <table class="matrix">
    <tr><th></th><th>Room Light</th><th>Darkness</th><th>Direct</th><th>Direct Range</th></tr>
    <tr><th>Left</th><td><%= fmt(data.Room_Light_L) %></td><td><%= fmt(data.Darkness_L) %></td><td><%= fmt(data.Direct_L) %></td><td><%= fmt(data.Direct_L1) %></td></tr>
    <tr><th>Right</th><td><%= fmt(data.Room_Light_R) %></td><td><%= fmt(data.Darkness_R) %></td><td><%= fmt(data.Direct_R) %></td><td><%= fmt(data.Direct_R1) %></td></tr>
    <tr><th colspan="5">Additional Pupils Info</th></tr>
    <tr><td colspan="5">UV Light Used: <%= data.UV_Light ? 'Yes' : 'No' %> · Range of sizes: <%= data.Direct_Light_Range ? 'Yes' : 'No' %></td></tr>
  </table>

  <div class="section">Oral / Nasal / Muscle Tone</div>
  <table class="matrix">
    <tr><th>Oral Cavity</th><td><%= fmt(data.Oral_Notes) %></td><th>Nasal Cavity</th><td><%= fmt(data.Nasal_Notes) %></td></tr>
    <tr><th>Reaction to Light</th><td><%= fmt(data.Reaction) %></td><th>Rebound Dilation</th><td><%= fmt(data.Rebound_Dilation) %></td></tr>
    <tr><th>Muscle Tone</th><td><%= fmt(data.Muscle_Tone) %></td><th>Notes</th><td><%= fmt(data.Muscle_Tone_Notes) %></td></tr>
    <tr><th colspan="4">Injection Sites</th></tr>
    <tr><td colspan="4"><%= data.Injection_None_Observed ? 'No injection sites observed' : '' %></td></tr>
  </table>

  <div class="section">Drug Use Details</div>
  <table class="matrix">
    <tr><th>Drugs / Medications</th><td><%= fmt(data.Drugs_Used) %></td></tr>
    <tr><th>Amount Used</th><td><%= fmt(data.Drugs_Amount) %></td></tr>
    <tr><th>Time of Use</th><td><%= fmt(data.Drugs_Time) %></td></tr>
    <tr><th>Where Used</th><td><%= fmt(data.Drugs_Location) %></td></tr>
  </table>

  <div class="section">Timeline</div>
  <table class="matrix">
    <tr><th>Arrest Date</th><td><%= fmt(data.Arrest_Date) %></td><th>Arrest Time</th><td><%= fmt(data.Arrest_Time) %></td></tr>
    <tr><th>DRE Notified</th><td><%= fmt(data.Notified_Time) %></td><th>Evaluation Start</th><td><%= fmt(data.Eval_Start_Time) %></td></tr>
    <tr><th>Evaluation Complete</th><td colspan="3"><%= fmt(data.Eval_End_Time) %></td></tr>
  </table>

  <div class="section">Evaluator Opinion</div>
  <table class="matrix">
    <tr>
      <th>Refused Evaluation</th><td><%= data.Subject_Refused ? 'Yes' : '' %></td>
      <th>Stopped Participating</th><td><%= data.Subject_Stopped ? 'Yes' : '' %></td>
      <th>Not Impaired</th><td><%= data.Not_Impaired ? 'Yes' : '' %></td>
    </tr>
    <tr><th colspan="6">Drug Categories Indicated</th></tr>
    <tr>
      <td colspan="6">
        <% [
          ['Medical', 'Medical'],
          ['Alcohol','Alcohol'],
          ['CNS_Depressant','CNS Depressant'],
          ['CNS_Stimulant','CNS Stimulant'],
          ['Hallucinogen','Hallucinogen'],
          ['Dissociative_Anesthetic','Dissociative Anesthetic'],
          ['Narcotic_Analgesic','Narcotic Analgesic'],
          ['Inhalant','Inhalant'],
          ['Cannabis','Cannabis']
        ].forEach(([field,label]) => { %>
          <span class="pill"><span style="width:10px;height:10px;border:1px solid #4b5563;display:inline-block;margin-right:4px;background:<%= data[field] ? '#0c2e63' : 'transparent' %>;"></span><%= label %></span>
        <% }) %>
      </td>
    </tr>
  </table>
  <div class="section">Opinion / Notes</div>
  <div class="box"><%= fmt(data.Opinion) %></div>

  <div class="section">Narrative</div>
  <div class="narr"><%= (data.Narrative || '').trim() %></div>

  <div class="foot">Face Sheet Page 3</div>
</div>

</body>
</html>
