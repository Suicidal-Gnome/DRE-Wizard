<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>DRE Face Sheet — Full Web Form</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --line:#e5e7eb; --muted:#6b7280; --ink:#0a1325; --accent:#0b5ed7;
      --radius:8px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--ink)}
    header{background:linear-gradient(90deg,#062c56,#0b3e7a);color:#fff;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    main{max-width:1100px;margin:16px auto;padding:0 14px}
    .panel{background:var(--card);border-radius:10px;box-shadow:0 2px 10px rgba(10,20,40,.06);padding:14px}

    .sec{margin-top:12px;border:1px solid var(--line);border-radius:10px}
    .sec h2{margin:0;padding:10px 12px;font-size:14px;background:#f2f5fb;border-bottom:1px solid var(--line)}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:12px}
    .grid.two{grid-template-columns:repeat(2,1fr)}
    .grid.one{grid-template-columns:1fr}
    .span-2{grid-column:span 2}
    .span-3{grid-column:span 3}

    .subheading{font-size:11px;font-weight:600;letter-spacing:.02em;text-transform:uppercase;color:var(--muted);margin:8px 0 2px}
    .group .subheading{margin:0}

    label{display:block;font-size:12px;color:var(--muted)}
    input,textarea,select{
      width:100%;margin-top:4px;padding:8px;border:1px solid var(--line);
      border-radius:var(--radius);font-size:14px;background:#fff
    }
    textarea{min-height:80px;resize:vertical}

    /* Group outline matches inputs */
    .group{
      border:1px solid var(--line); border-radius:var(--radius); padding:8px;
      background:#fff; margin-top:4px
    }
    .group-title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .inline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .inline input[type="text"],
    .inline select{min-width:180px}
    .hidden{display:none !important}
    .group table{width:100%;border-collapse:collapse;margin-top:8px}
    .group table th,.group table td{border:1px solid var(--line);padding:6px;font-size:13px;text-align:left}
    .group table select{width:100%;padding:6px;font-size:13px}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:10px 12px;font-weight:600;cursor:pointer}
    button.secondary{background:#e9edf6;color:#062c56}
    #narrative{white-space:pre-wrap;background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:8px;min-height:80px}
    small.muted{color:var(--muted)}
  </style>
</head>
<body>
<header><h1>DRE Face Sheet — Full Web Form</h1></header>
<main>
  <div class="panel">
    <form id="dreForm"></form>
    <div class="actions">
      <button id="previewBtn" type="button">Preview Narrative</button>
      <button id="pdfBtn" type="button" class="secondary">Generate PDF</button>
      <button id="saveJson" type="button" class="secondary">Download JSON</button>
      <label class="secondary" style="padding:10px;border-radius:8px;display:inline-block">
        <input type="file" id="loadJson" accept=".json" style="display:none"/>Load JSON
      </label>
      <button id="clearBtn" type="button" class="secondary">Clear</button>
    </div>
    <h3 style="margin:12px 0 6px">Narrative Preview</h3>
    <div id="narrative"></div>
    <small class="muted">PDF export hits <code>/pdf</code>. Narrative preview hits <code>/narrative</code>.</small>
  </div>
</main>

<script>
  // ========== Schema (with improved Case/Evaluator layout & outlined groups) ==========
  const SCHEMA = [
    ["Case / Evaluator","case",[
      ["CaseEval_Evaluator","subheading","Evaluator"],
      ["Evaluator","text","Evaluator (DRE Name)"],
      ["DRE_Number","text","DRE #"],
      ["Rolling_Log_Number","text","Rolling Log #"],
      ["Recorder","text","Recorder / Witnesses","span-3"],
      ["CaseEval_Case","subheading","Case Details"],
      ["Case_Number","text","Case #"],
      ["Incident_Number","text","Incident #"],
      ["Arresting_Officer","text","Arresting Officer"],
      ["Arresting_Agency","text","Officer’s Agency","span-2"],
      ["CaseEval_Logistics","subheading","Evaluation Logistics"],
      ["Eval_Date","date","Date Examined"],
      ["Eval_Time","time","Time Examined"],
      ["Location_Block","location","Evaluation Location"],
      ["Crash_Group","crashExclusive","Crash"],
      ["Chemical_Group","chemicalMulti","Chemical Test"],
      ["Miranda_Group","miranda","Miranda Warning Given","span-3"],
    ]],

    ["Subject","subject",[
      ["Subject_Name","text","Arrestee’s Name (Last, First, MI)","span-2"],
      ["Subject_DOB","date","DOB"],
      ["Subject_Age","number","Age"],
      ["Subject_Gender","select","Sex",["Male","Female","Nonbinary/Other","Unknown"]],
      ["Subject_Race","select","Race",[
        "White","Black/African American","Asian",
        "American Indian/Alaska Native","Native Hawaiian/Other Pacific Islander",
        "Hispanic/Latino","Middle Eastern/North African","Other","Unknown"
      ],"span-2"],
      ["Breath_Result","text","Breath Test — Results"],
      ["Breath_Instrument_Number","text","Breath Test — Instrument #"]
    ]],

    ["Interview","interview",[
      ["Food_When","text","What have you eaten today? When?","span-3"],
      ["Drinking_When","text","When have you been drinking?"],
      ["Drinking_HowMuch","text","How much have you had?"],
      ["Drinking_LastTime","text","Time of last drink"],
      ["Time_Now_Subjective","text","Time now (stated)"],
      ["Time_Now_Actual","text","Actual current time"],
      ["Sleep_Last","text","When did you last sleep?"],
      ["Sleep_Length","text","How long did you sleep?"],
    ]],

    ["Medical / Physical","medical",[
      ["Sick_Injured","yesNoNotes","Are you sick or injured?"],
      ["Diabetic_Epileptic","yesNoNotes","Are you diabetic or epileptic?"],
      ["Insulin","yesNo","Do you take insulin?"],
      ["Physical_Defects","yesNoNotes","Any physical defects?"],
      ["Under_Doctor","yesNoNotes","Under the care of a doctor or dentist?"],
      ["Medication_Drugs","yesNoNotes","Taking any medication or drugs?"],
    ]],

    ["Preliminary Exam","prelim",[
      ["Attitude","text","Attitude"],
      ["Coordination","text","Coordination"],
      ["Speech","text","Speech"],
      ["Breath_Odor","text","Breath Odor"],
      ["Face","text","Face"],
      ["Pulse1_Rate","text","First Pulse"],
      ["Pulse1_Time","text","First Pulse Time"],
      ["Corrective_Lenses_Group","correctiveLenses","Corrective Lenses","span-3"],
      ["Eyes_Observed","checkboxList","Eyes",["Normal","Watery","Bloodshot"]],
      ["Blindness_Affected","checkboxList","Blindness",["None","Left","Right"],{exclusive:"None"}],
      ["Tracking","radioOptions","Tracking",["Equal","Unequal"]],
      ["Pupil_Status","pupilStatus","Pupil size / notes","span-3"],
      ["Resting_Nyst","yesNo","Resting Nystagmus"],
      ["Vertical_Nyst","yesNo","Vertical Nystagmus"],
      ["Follow_Stimulus","yesNo","Able to follow stimulus"],
      ["Eyelids","radioOptions","Eyelids",["Normal","Droopy"]],
      ["Prelim_Notes","text","Preliminary Exam Notes","span-3"]
    ]],

    ["HGN / VGN / Convergence","hgn",[
      ["HGN_Findings","hgnClues","Horizontal Gaze Nystagmus Findings","span-3"],
      ["VGN","yesNo","Vertical Gaze Nystagmus Present?"],
      ["LOC","text","Lack of Convergence","span-3"]
    ]],

    ["Psychophysical Tests","psychophys",[
      ["Romberg","text","Modified Romberg Balance Test","span-3"],
      ["MRomberg","text","Time Estimation (est. 30 sec)","span-3"],
      ["WnT","text","Walk and Turn (notes/clues)","span-3"],
      ["OLS","text","One Leg Stand (L/R, time/clues)","span-3"],
      ["FTN","text","Finger to Nose","span-3"]
    ]],

    ["Vital Signs & Pupils","vitals",[
      ["Pulse2","text","Second Pulse / Time"],
      ["BP","text","Blood Pressure"],
      ["Temp","text","Body Temperature"],
      ["Pupil_Room","text","Pupil Size — Room light (L/R)"],
      ["Pupil_Dark","text","Pupil Size — Darkness (L/R)"],
      ["Pupil_Near","text","Pupil Size — Direct/Near (L/R)"],
      ["Pupil_LightReact","text","Reaction to Light"],
      ["Pulse3","text","Third Pulse / Time"],
      ["UV_Used","text","UV light used (Y/N)"]
    ]],

    ["Oral / Nasal Cavity","oral",[
      ["Oral_Cavity","text","Oral Cavity","span-3"],
      ["Nasal_Cavity","text","Nasal Cavity","span-3"],
      ["Rebound_Dilation","text","Rebound Dilation","span-3"]
    ]],

    ["Drug Use Details","druguse",[
      ["Drugs_Used","text","What drugs or medications have you been using?","span-3"],
      ["Dose","text","How much?","span-3"],
      ["Time_of_Use","text","Time of use","span-3"],
      ["Where_Used","text","Where were the drugs used?","span-3"],
      ["Ingestion","text","Signs of ingestion (odor/residue/paraphernalia)","span-3"]
    ]],

    ["Timeline","timeline",[
      ["Arrest_DateTime","text","Date and time of arrest","span-3"],
      ["DRE_Notified","text","Time DRE notified","span-3"],
      ["Eval_Start","text","Evaluation start time"],
      ["Eval_Complete","text","Evaluation completion time"]
    ]],

    ["Toxicology","toxicology",[
      ["Oral_Fluid","text","Oral Fluid"],
      ["Instrument_Number","text","Instrument #"],
      ["Oral_Results","text","Oral fluid results"],
      ["Urine","text","Urine"],
      ["Blood","text","Blood"],
      ["Collected_By","text","Collected By"]
    ]],

    ["Opinion / Flags","opinion",[
      ["Indicated","text","Drug Categories Indicated","span-3"],
      ["Opinion","textarea","DRE Opinion / Conclusion","span-3"],
      ["Refused_All","text","Subject refused entire evaluation (Y/N/notes)","span-3"],
      ["Stopped_Participating","text","Subject stopped participating during eval (Y/N/when)","span-3"]
    ]]
  ];

  const CRASH_OPTIONS = [
    { field: "Crash_None", label: "None" },
    { field: "Crash_Fatal", label: "Fatal" },
    { field: "Crash_Injury", label: "Injury" },
    { field: "Crash_Property", label: "Property" }
  ];

  const CHEMICAL_OPTIONS = [
    { field: "Chemical_Refused", label: "Refused" },
    { field: "Chemical_OralFluid", label: "Oral Fluid" },
    { field: "Chemical_Blood", label: "Blood" },
    { field: "Chemical_Urine", label: "Urine" }
  ];

  const STATE_OPTIONS = [
    ["", "Select State"],
    ["Alabama", "Alabama (AL)"],
    ["Alaska", "Alaska (AK)"],
    ["Arizona", "Arizona (AZ)"],
    ["Arkansas", "Arkansas (AR)"],
    ["California", "California (CA)"],
    ["Colorado", "Colorado (CO)"],
    ["Connecticut", "Connecticut (CT)"],
    ["Delaware", "Delaware (DE)"],
    ["District of Columbia", "District of Columbia (DC)"],
    ["Florida", "Florida (FL)"],
    ["Georgia", "Georgia (GA)"],
    ["Hawaii", "Hawaii (HI)"],
    ["Idaho", "Idaho (ID)"],
    ["Illinois", "Illinois (IL)"],
    ["Indiana", "Indiana (IN)"],
    ["Iowa", "Iowa (IA)"],
    ["Kansas", "Kansas (KS)"],
    ["Kentucky", "Kentucky (KY)"],
    ["Louisiana", "Louisiana (LA)"],
    ["Maine", "Maine (ME)"],
    ["Maryland", "Maryland (MD)"],
    ["Massachusetts", "Massachusetts (MA)"],
    ["Michigan", "Michigan (MI)"],
    ["Minnesota", "Minnesota (MN)"],
    ["Mississippi", "Mississippi (MS)"],
    ["Missouri", "Missouri (MO)"],
    ["Montana", "Montana (MT)"],
    ["Nebraska", "Nebraska (NE)"],
    ["Nevada", "Nevada (NV)"],
    ["New Hampshire", "New Hampshire (NH)"],
    ["New Jersey", "New Jersey (NJ)"],
    ["New Mexico", "New Mexico (NM)"],
    ["New York", "New York (NY)"],
    ["North Carolina", "North Carolina (NC)"],
    ["North Dakota", "North Dakota (ND)"],
    ["Ohio", "Ohio (OH)"],
    ["Oklahoma", "Oklahoma (OK)"],
    ["Oregon", "Oregon (OR)"],
    ["Pennsylvania", "Pennsylvania (PA)"],
    ["Rhode Island", "Rhode Island (RI)"],
    ["South Carolina", "South Carolina (SC)"],
    ["South Dakota", "South Dakota (SD)"],
    ["Tennessee", "Tennessee (TN)"],
    ["Texas", "Texas (TX)"],
    ["Utah", "Utah (UT)"],
    ["Vermont", "Vermont (VT)"],
    ["Virginia", "Virginia (VA)"],
    ["Washington", "Washington (WA)"],
    ["West Virginia", "West Virginia (WV)"],
    ["Wisconsin", "Wisconsin (WI)"],
    ["Wyoming", "Wyoming (WY)"]
  ];

  const formEl = document.getElementById("dreForm");

  function build(){
    formEl.innerHTML = "";
    for (const [title, key, fields] of SCHEMA){
      const sec = document.createElement("section");
      sec.className = "sec";
      sec.innerHTML = `<h2>${title}</h2>`;
      const grid = document.createElement("div");
      grid.className = fields.length <= 2 ? "grid one" : (fields.length <= 6 ? "grid two" : "grid");

      for (const f of fields){
        const name = f[0];
        const type = f[1];
        const label = f[2];
        const extras = f.slice(3);
        const spanClass = extras.find(val => typeof val === "string" && val.startsWith("span-"));
        const wrap = document.createElement("div");
        if (spanClass) wrap.classList.add(spanClass);

        if (type === "subheading"){
          wrap.classList.add("span-3");
          wrap.innerHTML = `<div class="subheading">${label}</div>`;

        } else if (type === "select"){
          const opts = extras.find(Array.isArray) || [];
          wrap.innerHTML = `<label>${label}
            <select name="${name}" id="${name}">
              ${opts
                .map(opt => Array.isArray(opt)
                  ? `<option value="${opt[0]}">${opt[1]}</option>`
                  : `<option value="${opt}">${opt}</option>`)
                .join("")}
            </select></label>`;

        } else if (type === "location"){
          wrap.classList.add("span-3");
          wrap.innerHTML = `
            <div class="group">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label style="flex:1 1 240px">Address
                  <input type="text" name="Location" id="Location" placeholder="Street / facility" />
                </label>
                <label style="flex:0 0 160px">State
                  <select name="Location_State" id="Location_State">
                    ${STATE_OPTIONS.map(opt => `<option value="${opt[0]}">${opt[1]}</option>`).join("")}
                  </select>
                </label>
                <label style="flex:1 1 200px">County / Parish / Borough
                  <input type="text" name="Location_County" id="Location_County" placeholder="Jurisdiction" />
                </label>
              </div>
            </div>`;

        } else if (type === "miranda"){
          wrap.innerHTML = `
            <div class="group">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label><input type="radio" name="Miranda" value="Yes"> Yes</label>
                <label><input type="radio" name="Miranda" value="No"> No</label>
                <input type="text" name="Miranda_Notes" id="Miranda_Notes" placeholder="Notes (optional)">
              </div>
            </div>`;

        } else if (type === "crashExclusive"){
          wrap.innerHTML = `
            <div class="group">
              <div class="group-title">${label} <span class="muted">(select one)</span></div>
              <div class="inline" id="CrashGroup">
                <label><input type="checkbox" name="Crash_None" value="true"> None</label>
                <label><input type="checkbox" name="Crash_Fatal" value="true"> Fatal</label>
                <label><input type="checkbox" name="Crash_Injury" value="true"> Injury</label>
                <label><input type="checkbox" name="Crash_Property" value="true"> Property</label>
              </div>
            </div>`;

        } else if (type === "chemicalMulti"){
          wrap.innerHTML = `
            <div class="group">
              <div class="group-title">${label} <span class="muted">(select all that apply)</span></div>
              <div class="inline">
                <label><input type="checkbox" name="Chemical_Refused" value="true"> Refused</label>
                <label><input type="checkbox" name="Chemical_OralFluid" value="true"> Oral Fluid</label>
                <label><input type="checkbox" name="Chemical_Blood" value="true"> Blood</label>
                <label><input type="checkbox" name="Chemical_Urine" value="true"> Urine</label>
              </div>
            </div>`;

        } else if (type === "yesNoNotes"){
          wrap.innerHTML = `
            <div class="group yes-no-notes" data-field="${name}">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label><input type="radio" name="${name}_Answer" value="Yes"> Yes</label>
                <label><input type="radio" name="${name}_Answer" value="No"> No</label>
                <input type="text" class="notes hidden" name="${name}_Notes" id="${name}_Notes" placeholder="Notes (if yes)">
              </div>
            </div>`;

        } else if (type === "yesNo"){
          wrap.innerHTML = `
            <div class="group yes-no" data-field="${name}">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label><input type="radio" name="${name}" value="Yes"> Yes</label>
                <label><input type="radio" name="${name}" value="No"> No</label>
              </div>
            </div>`;

        } else if (type === "checkboxList"){
          const options = extras.find(Array.isArray) || [];
          const config = extras.find(val => val && typeof val === "object" && !Array.isArray(val)) || {};
          const exclusive = config.exclusive ? ` data-exclusive="${config.exclusive}"` : "";
          wrap.innerHTML = `
            <div class="group checkbox-list" data-field="${name}"${exclusive}>
              <div class="group-title">${label}</div>
              <div class="inline">
                ${options
                  .map((opt, idx) => `<label><input type="checkbox" name="${name}" value="${opt}" data-collect="list"> ${opt}</label>`)
                  .join("")}
              </div>
            </div>`;

        } else if (type === "radioOptions"){
          const options = extras.find(Array.isArray) || [];
          wrap.innerHTML = `
            <div class="group radio-options" data-field="${name}">
              <div class="group-title">${label}</div>
              <div class="inline">
                ${options
                  .map(opt => `<label><input type="radio" name="${name}" value="${opt}"> ${opt}</label>`)
                  .join("")}
              </div>
            </div>`;

        } else if (type === "pupilStatus"){
          wrap.innerHTML = `
            <div class="group pupil-status" data-field="${name}">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label><input type="radio" name="Pupil_Balance" value="Equal"> Equal</label>
                <label><input type="radio" name="Pupil_Balance" value="Unequal"> Unequal</label>
                <input type="text" class="notes hidden" name="Pupil_Notes" id="Pupil_Notes" placeholder="Notes">
              </div>
            </div>`;

        } else if (type === "correctiveLenses"){
          wrap.innerHTML = `
            <div class="group corrective-lenses">
              <div class="group-title">${label}</div>
              <div class="inline">
                <label><input type="checkbox" name="Corrective_Lenses_None" value="true" data-exclusive="true"> None</label>
                <label><input type="checkbox" name="Corrective_Lenses_Glasses" value="true"> Glasses</label>
                <label><input type="checkbox" name="Corrective_Lenses_Contacts" value="true" data-toggle="contacts"> Contacts</label>
                <div class="inline contact-type hidden">
                  <label><input type="radio" name="Corrective_Lenses_ContactsType" value="Hard"> Hard</label>
                  <label><input type="radio" name="Corrective_Lenses_ContactsType" value="Soft"> Soft</label>
                </div>
              </div>
            </div>`;

        } else if (type === "hgnClues"){
          wrap.classList.add("span-3");
          wrap.innerHTML = `
            <div class="group hgn-clues">
              <div class="group-title">${label}</div>
              <table>
                <thead>
                  <tr><th></th><th>Lack of Smooth Pursuit</th><th>Distinct &amp; Sustained at Max Deviation</th><th>Angle of Onset</th></tr>
                </thead>
                <tbody>
                  <tr>
                    <th>Left Eye</th>
                    <td>
                      <select name="HGN_Left_LSP">
                        <option value="">Select</option>
                        <option value="Present">Present</option>
                        <option value="None">None</option>
                      </select>
                    </td>
                    <td>
                      <select name="HGN_Left_MD">
                        <option value="">Select</option>
                        <option value="Present">Present</option>
                        <option value="None">None</option>
                      </select>
                    </td>
                    <td>
                      <select name="HGN_Left_AOO">
                        <option value="">Select</option>
                        <option value="None">None</option>
                        <option value="Immediate">Immediate</option>
                        <option value="30">30</option>
                        <option value="35">35</option>
                        <option value="40">40</option>
                        <option value="45">45</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <th>Right Eye</th>
                    <td>
                      <select name="HGN_Right_LSP">
                        <option value="">Select</option>
                        <option value="Present">Present</option>
                        <option value="None">None</option>
                      </select>
                    </td>
                    <td>
                      <select name="HGN_Right_MD">
                        <option value="">Select</option>
                        <option value="Present">Present</option>
                        <option value="None">None</option>
                      </select>
                    </td>
                    <td>
                      <select name="HGN_Right_AOO">
                        <option value="">Select</option>
                        <option value="None">None</option>
                        <option value="Immediate">Immediate</option>
                        <option value="30">30</option>
                        <option value="35">35</option>
                        <option value="40">40</option>
                        <option value="45">45</option>
                      </select>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>`;

        } else if (type === "textarea"){
          wrap.innerHTML = `<label>${label}<textarea name="${name}" id="${name}"></textarea></label>`;

        } else {
          const t = (type==="number") ? "number" : (type==="date"?"date":(type==="time"?"time":"text"));
          const readonly = name === "Subject_Age" ? " readonly" : "";
          const placeholder = name === "Subject_Age" ? " placeholder=\"Auto calculated\"" : "";
          wrap.innerHTML = `<label>${label}<input name="${name}" id="${name}" type="${t}"${readonly}${placeholder}/></label>`;
        }

        grid.appendChild(wrap);
      }

      sec.appendChild(grid);
      formEl.appendChild(sec);
    }

    // Enforce exclusive Crash checkboxes (only one checked at a time)
    const crashInputs = formEl.querySelectorAll('#CrashGroup input[type="checkbox"]');
    crashInputs.forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if (cb.checked){
          crashInputs.forEach(x=>{ if (x!==cb) x.checked = false; });
        }
      });
    });

    setupComputedListeners();
    setupConditionalControls();
  }

  // ---------- Data helpers ----------
  function updateComputedAge(){
    const ageInput = formEl.querySelector("#Subject_Age");
    const dobInput = formEl.querySelector("#Subject_DOB");
    if (!ageInput || !dobInput){
      return;
    }

    const dobValue = dobInput.value;
    if (!dobValue){
      ageInput.value = "";
      return;
    }

    const birth = new Date(dobValue + "T00:00:00");
    if (Number.isNaN(birth.getTime())){
      ageInput.value = "";
      return;
    }

    const evalDateInput = formEl.querySelector("#Eval_Date");
    const refValue = evalDateInput && evalDateInput.value ? evalDateInput.value : null;
    const refDate = refValue ? new Date(refValue + "T00:00:00") : new Date();
    if (Number.isNaN(refDate.getTime())){
      ageInput.value = "";
      return;
    }

    let age = refDate.getFullYear() - birth.getFullYear();
    const monthDiff = refDate.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && refDate.getDate() < birth.getDate())){
      age -= 1;
    }
    ageInput.value = age >= 0 ? age : "";
  }

  function setupComputedListeners(){
    const dobInput = formEl.querySelector("#Subject_DOB");
    const evalDateInput = formEl.querySelector("#Eval_Date");
    [dobInput, evalDateInput].forEach(el => {
      if (el){
        el.addEventListener("input", updateComputedAge);
        el.addEventListener("change", updateComputedAge);
      }
    });
    updateComputedAge();
  }

  function applyYesNoNotes(container, clear){
    const notes = container.querySelector('.notes');
    if (!notes) return;
    const checked = container.querySelector('input[type="radio"]:checked');
    const hasNotes = notes.value && notes.value.trim().length > 0;
    const show = (checked && checked.value === 'Yes') || hasNotes;
    notes.classList.toggle('hidden', !show);
    if (!show && clear){
      notes.value = '';
    }
  }

  function applyPupilStatus(container, clear){
    const notes = container.querySelector('.notes');
    if (!notes) return;
    const checked = container.querySelector('input[type="radio"]:checked');
    const hasNotes = notes.value && notes.value.trim().length > 0;
    const show = (checked && checked.value === 'Unequal') || hasNotes;
    notes.classList.toggle('hidden', !show);
    if (!show && clear){
      notes.value = '';
    }
  }

  function enforceExclusive(container){
    const exclusiveValue = container.getAttribute('data-exclusive');
    if (!exclusiveValue) return;
    const boxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
    const exclusiveBox = boxes.find(cb => cb.value === exclusiveValue);
    if (!exclusiveBox) return;
    if (exclusiveBox.checked){
      boxes.forEach(cb => { if (cb !== exclusiveBox) cb.checked = false; });
    } else if (boxes.some(cb => cb !== exclusiveBox && cb.checked)){
      exclusiveBox.checked = false;
    }
  }

  function applyCorrectiveLensState(wrap, clear){
    if (!wrap) return;
    const contactCheckbox = wrap.querySelector('input[name="Corrective_Lenses_Contacts"]');
    const contactType = wrap.querySelector('.contact-type');
    const typeRadios = wrap.querySelectorAll('input[name="Corrective_Lenses_ContactsType"]');
    const hasTypeSelection = Array.from(typeRadios).some(r => r.checked);
    const show = (contactCheckbox && contactCheckbox.checked) || hasTypeSelection;
    if (contactType){
      contactType.classList.toggle('hidden', !show);
      if (!show && clear){
        typeRadios.forEach(r => { r.checked = false; });
      }
    }
  }

  function setupConditionalControls(){
    formEl.querySelectorAll('.yes-no-notes').forEach(container => {
      container.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => applyYesNoNotes(container, true));
      });
    });

    formEl.querySelectorAll('.checkbox-list[data-exclusive]').forEach(container => {
      const boxes = container.querySelectorAll('input[type="checkbox"]');
      boxes.forEach(cb => {
        cb.addEventListener('change', () => {
          enforceExclusive(container);
        });
      });
    });

    const corrective = formEl.querySelector('.corrective-lenses');
    if (corrective){
      const noneBox = corrective.querySelector('input[data-exclusive]');
      const contactBox = corrective.querySelector('input[name="Corrective_Lenses_Contacts"]');
      const boxes = corrective.querySelectorAll('input[type="checkbox"]');
      boxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (noneBox && cb === noneBox && cb.checked){
            boxes.forEach(other => { if (other !== cb) other.checked = false; });
            applyCorrectiveLensState(corrective, true);
            return;
          }
          if (noneBox && cb !== noneBox && cb.checked){
            noneBox.checked = false;
          }
          if (contactBox && cb === contactBox){
            applyCorrectiveLensState(corrective, !contactBox.checked);
          }
        });
      });
    }

    formEl.querySelectorAll('.pupil-status').forEach(container => {
      container.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => applyPupilStatus(container, false));
      });
    });

    refreshConditionalFields();
  }

  function refreshConditionalFields(){
    formEl.querySelectorAll('.yes-no-notes').forEach(container => applyYesNoNotes(container, false));
    formEl.querySelectorAll('.checkbox-list[data-exclusive]').forEach(container => enforceExclusive(container));
    applyCorrectiveLensState(formEl.querySelector('.corrective-lenses'), false);
    formEl.querySelectorAll('.pupil-status').forEach(container => applyPupilStatus(container, false));
  }

  function dataFromForm(){
    updateComputedAge();
    const data = {};
    const listValues = {};
    formEl.querySelectorAll("input,textarea,select").forEach(el => {
      if (!el.name) return;
      if (el.type === "radio"){
        if (el.checked) data[el.name] = el.value;
      } else if (el.type === "checkbox"){
        if (el.dataset.collect === "list"){
          if (!listValues[el.name]) listValues[el.name] = [];
          if (el.checked) listValues[el.name].push(el.value);
        } else if (el.checked){
          data[el.name] = true;
        }
      } else {
        data[el.name] = el.value;
      }
    });

    Object.entries(listValues).forEach(([key, values]) => {
      if (values.length) data[key] = values;
    });

    let crashValue = "";
    CRASH_OPTIONS.forEach(({ field, label }) => {
      const el = formEl.querySelector(`input[name="${field}"]`);
      if (el && el.checked) {
        data[field] = true;
        if (!crashValue) crashValue = label;
      }
    });
    if (crashValue) data.Crash = crashValue;

    const chemicalSelections = [];
    CHEMICAL_OPTIONS.forEach(({ field, label }) => {
      const el = formEl.querySelector(`input[name="${field}"]`);
      if (el && el.checked) {
        data[field] = true;
        chemicalSelections.push(label);
      }
    });
    if (chemicalSelections.length) data.Chemical_Test = chemicalSelections.join(", ");

    const yesNoNoteFields = [
      "Sick_Injured",
      "Diabetic_Epileptic",
      "Physical_Defects",
      "Under_Doctor",
      "Medication_Drugs"
    ];
    yesNoNoteFields.forEach(name => {
      const answer = data[`${name}_Answer`];
      const notes = data[`${name}_Notes`];
      if (answer){
        data[name] = answer === "Yes" && notes ? `Yes — ${notes}` : answer;
      }
    });

    const eyesSelections = Array.isArray(data.Eyes_Observed) ? data.Eyes_Observed : [];
    if (eyesSelections.length) data.Eyes_Observed_Display = eyesSelections.join(", ");

    const blindnessSelections = Array.isArray(data.Blindness_Affected) ? data.Blindness_Affected : [];
    if (blindnessSelections.length) data.Blindness_Affected_Display = blindnessSelections.join(", ");

    const lensParts = [];
    if (data.Corrective_Lenses_None) lensParts.push("None");
    if (data.Corrective_Lenses_Glasses) lensParts.push("Glasses");
    if (data.Corrective_Lenses_Contacts){
      const type = data.Corrective_Lenses_ContactsType;
      lensParts.push(type ? `Contacts (${type})` : "Contacts");
    }
    if (lensParts.length) data.Corrective_Lenses = lensParts.join(", ");

    if (data.Pulse1_Rate || data.Pulse1_Time){
      data.Pulse1 = [data.Pulse1_Rate, data.Pulse1_Time].filter(Boolean).join(" @ ");
    }

    const pupilBalance = data.Pupil_Balance || "";
    const pupilNotes = data.Pupil_Notes || "";
    if (pupilBalance || pupilNotes){
      data.Pupil_Explain = [pupilBalance, pupilNotes].filter(Boolean).join(" — ");
    }

    const buildEyeSummary = side => {
      const parts = [];
      const lsp = data[`HGN_${side}_LSP`];
      const md = data[`HGN_${side}_MD`];
      const aoo = data[`HGN_${side}_AOO`];
      if (lsp) parts.push(`LSP: ${lsp}`);
      if (md) parts.push(`Max Dev: ${md}`);
      if (aoo) parts.push(`Angle: ${aoo}`);
      return parts.join("; ");
    };
    const leftSummary = buildEyeSummary("Left");
    const rightSummary = buildEyeSummary("Right");
    if (leftSummary) data.HGN_Left = leftSummary;
    if (rightSummary) data.HGN_Right = rightSummary;
    if (data.HGN_Left_LSP || data.HGN_Right_LSP){
      data.HGN_LSP = [
        data.HGN_Left_LSP ? `L: ${data.HGN_Left_LSP}` : "",
        data.HGN_Right_LSP ? `R: ${data.HGN_Right_LSP}` : ""
      ].filter(Boolean).join(" / ");
    }
    if (data.HGN_Left_MD || data.HGN_Right_MD){
      data.HGN_MD = [
        data.HGN_Left_MD ? `L: ${data.HGN_Left_MD}` : "",
        data.HGN_Right_MD ? `R: ${data.HGN_Right_MD}` : ""
      ].filter(Boolean).join(" / ");
    }
    if (data.HGN_Left_AOO || data.HGN_Right_AOO){
      data.HGN_AOO = [
        data.HGN_Left_AOO ? `L: ${data.HGN_Left_AOO}` : "",
        data.HGN_Right_AOO ? `R: ${data.HGN_Right_AOO}` : ""
      ].filter(Boolean).join(" / ");
    }

    const drinkingSummary = [];
    if (data.Drinking_When) drinkingSummary.push(`When: ${data.Drinking_When}`);
    if (data.Drinking_HowMuch) drinkingSummary.push(`How much: ${data.Drinking_HowMuch}`);
    if (data.Drinking_LastTime) drinkingSummary.push(`Last drink: ${data.Drinking_LastTime}`);
    if (drinkingSummary.length) data.Drinking = drinkingSummary.join(" | ");
    return data;
  }

  async function postJSON(url, obj){
    const res = await fetch(url,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(obj)});
    if(!res.ok) throw new Error(await res.text());
    return res;
  }

  // ---------- Buttons ----------
  document.getElementById("previewBtn").onclick = async ()=>{
    try{
      const res = await postJSON("/narrative", dataFromForm());
      const { narrative } = await res.json();
      document.getElementById("narrative").textContent = narrative || "(empty)";
    }catch(e){ alert("Narrative error: "+e.message); }
  };

  document.getElementById("pdfBtn").onclick = async ()=>{
    try{
      const res = await postJSON("/pdf", dataFromForm());
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="dre-report.pdf"; a.click();
      URL.revokeObjectURL(url);
    }catch(e){ alert("PDF error: "+e.message); }
  };

  document.getElementById("saveJson").onclick = ()=>{
    const blob = new Blob([JSON.stringify(dataFromForm(), null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="dre-report.json"; a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("loadJson").addEventListener("change", (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        formEl.querySelectorAll('input,textarea,select').forEach(el => {
          if (!el.name) return;
          const value = data[el.name];
          if (el.type === 'radio'){
            el.checked = value !== undefined && value === el.value;
          } else if (el.type === 'checkbox'){
            if (el.dataset.collect === 'list'){
              const raw = data[el.name] !== undefined ? data[el.name] : data[`${el.name}_Display`];
              let values = [];
              if (Array.isArray(raw)) values = raw.map(String);
              else if (typeof raw === 'string') values = raw.split(/[,|]/).map(s => s.trim()).filter(Boolean);
              el.checked = values.includes(el.value);
            } else {
              el.checked = !!value;
            }
          } else if (value !== undefined){
            el.value = value;
          } else {
            el.value = '';
          }
        });

        const yesNoNoteFields = [
          "Sick_Injured",
          "Diabetic_Epileptic",
          "Physical_Defects",
          "Under_Doctor",
          "Medication_Drugs"
        ];
        yesNoNoteFields.forEach(name => {
          let answer = data[`${name}_Answer`];
          let notes = data[`${name}_Notes`];
          if (!answer && typeof data[name] === 'string'){
            const raw = data[name];
            const lower = raw.toLowerCase();
            if (lower.startsWith('yes')){
              answer = 'Yes';
              if (!notes){
                const dashIdx = raw.indexOf('—');
                const colonIdx = raw.indexOf(':');
                const sepIdx = dashIdx >= 0 ? dashIdx : colonIdx;
                if (sepIdx >= 0) notes = raw.slice(sepIdx + 1).trim();
              }
            } else if (lower.startsWith('no')){
              answer = 'No';
            }
          }
          if (answer){
            const radio = formEl.querySelector(`input[name="${name}_Answer"][value="${answer}"]`);
            if (radio) radio.checked = true;
          }
          if (notes){
            const notesInput = formEl.querySelector(`#${name}_Notes`);
            if (notesInput) notesInput.value = notes;
          }
        });

        if (data.Drinking && !data.Drinking_When && !data.Drinking_HowMuch && !data.Drinking_LastTime){
          const drinkWhen = formEl.querySelector('#Drinking_When');
          if (drinkWhen) drinkWhen.value = data.Drinking;
        }

        if (!data.Pulse1_Rate && typeof data.Pulse1 === 'string'){
          const parts = data.Pulse1.split('@');
          const rate = parts[0] ? parts[0].trim() : '';
          const time = parts[1] ? parts[1].trim() : '';
          const rateInput = formEl.querySelector('input[name="Pulse1_Rate"]');
          const timeInput = formEl.querySelector('input[name="Pulse1_Time"]');
          if (rateInput && rate) rateInput.value = rate;
          if (timeInput && time) timeInput.value = time;
        }

        const crashLabel = (data.Crash || "").toLowerCase();
        CRASH_OPTIONS.forEach(({ field, label }) => {
          const el = formEl.querySelector(`input[name="${field}"]`);
          if (el) {
            const matchFromString = crashLabel && crashLabel === label.toLowerCase();
            el.checked = !!(data[field] || matchFromString);
          }
        });

        const chemicalLabels = new Set(
          (data.Chemical_Test || "")
            .split(",")
            .map(s => s.trim().toLowerCase())
            .filter(Boolean)
        );
        CHEMICAL_OPTIONS.forEach(({ field, label }) => {
          const el = formEl.querySelector(`input[name="${field}"]`);
          if (el) {
            const matchFromString = chemicalLabels.has(label.toLowerCase());
            el.checked = !!(data[field] || matchFromString);
          }
        });

        refreshConditionalFields();
        updateComputedAge();
      }catch{ alert("Invalid JSON");}
    };
    r.readAsText(f);
  });

  document.getElementById("clearBtn").onclick = ()=>{
    formEl.querySelectorAll("input,textarea,select").forEach(el=>{
      if (el.type === "checkbox" || el.type === "radio") el.checked = false;
      else el.value = "";
    });
    document.getElementById("narrative").textContent = "";
    updateComputedAge();
    refreshConditionalFields();
  };

  // init
  build();
</script>
</body>
</html>
